---
description: Project overview, structure, and build system for the based C library
alwaysApply: true
---

# based — Project Overview

A cross-platform C11 utility library by Christian Luppi (MIT License). It provides portable primitive types, custom keywords, utility macros, and environment detection.

## Structure

```
include/based.h              # Public umbrella header — include this
include/basic/
  assert.h                   # Runtime assert macro + assert_mode / assert_callback API
  codespace.h                # callsite and source_location structs + CALLSITE_HERE macro
  env_defines.h              # Platform / arch / compiler / build detection macros
  keyword_defines.h          # Custom keyword aliases (read_only, func, global_var, …)
  primitive_types.h          # Portable type aliases (i32, f64, b8, sz, …)
  utility_defines.h          # General-purpose utility macros
include/containers/
  binary_tree.h              # Intrusive structural binary tree (left/right/parent; INSERT_LEFT/RIGHT, REMOVE, ROTATE_LEFT/RIGHT, FOREACH preorder/inorder/postorder)
  bitset.h                   # Fixed-width bitset over u64[] (SET/CLEAR/TEST/TOGGLE/COUNT/FIRST_SET/FOREACH_SET)
  doubly_list.h              # Intrusive doubly-linked list with head+tail (PUSH/POP front+back, REMOVE, INSERT, FOREACH)
  hash_map.h                 # Open-addressing Robin Hood hash table (u64 key → void* value, iterator, hash_* utils)
  ring_list.h                # Intrusive circular doubly-linked list (PUSH/POP front+back, REMOVE, INSERT, FOREACH)
  singly_list.h              # Intrusive singly-linked list with head+tail (PUSH_FRONT/BACK, POP_FRONT, FOREACH)
  stack_list.h               # Intrusive singly-linked LIFO stack (STACK_LIST_PUSH/POP/FOREACH)
  tree.h                     # Intrusive N-ary tree, left-child/right-sibling (parent/first_child/last_child/next_sibling/prev_sibling; INSERT_CHILD/BEFORE/AFTER, REMOVE, FOREACH_CHILDREN, FOREACH_PREORDER)
include/memory/
  allocator.h                # Custom allocator interface (alloc/free/realloc callbacks)
  arena.h                    # Linear (bump-pointer) allocator with block chain and optional mutex
  buffer.h                   # Non-owning buffer view (ptr + size, slicing, split, cmp, set)
  heap.h                     # General-purpose allocator with free-list, coalescing, and optional mutex
  pool.h                     # Fixed-size object pool: O(1) alloc/dealloc via intrusive free list
  ring.h                     # Byte-oriented circular buffer with read/write/peek/skip and optional mutex
  scratch.h                  # Arena checkpoint (scratch_begin/end): rewind tail block and free new blocks
  vmem.h                     # OS virtual-memory primitives: reserve/commit/decommit/release/alloc/free
include/threads/
  thread.h                   # Thread creation, join, detach, ID (opaque handle + thread_func)
  thread_current.h           # Current-thread utilities (ID, sleep, yield, get/set priority)
  thread_group.h             # Thread group: spawn/add/join-all/detach-all a set of threads
  atomics.h                  # Lock-free atomic types and operations (atomic_i32/u32/i64/u64/ptr)
  condvar.h                  # Condition variable (wait/signal/broadcast, with timeout)
  mutex.h                    # Mutual-exclusion lock (lock/trylock/unlock)
  rwlock.h                   # Reader-writer lock (read_lock/write_lock + try variants)
  semaphore.h                # Counting semaphore (wait/trywait/wait_timeout/signal)
  spinlock.h                 # CPU spinlock value-type (lock/trylock/unlock)
src/basic/
  assert.c                   # _assert / assert_set_mode / assert_set_callback implementations
  log.c                      # _log / log_set_level / log_set_callback implementations
src/containers/
  hash_map.c                 # hash_map_create/destroy/set/get/has/remove/clear/next + hash_* utilities
src/memory/
  allocator.c                # allocator_alloc / calloc / dealloc / realloc implementations
  arena.c                    # arena_create / destroy / add_block / remove_block / alloc / realloc / clear
  buffer.c                   # buffer_* implementations (constructors, slicing, cmp, set)
  heap.c                     # heap_create / destroy / add_block / remove_block / alloc / dealloc / realloc / clear
  pool.c                     # pool_create / destroy / add_block / remove_block / alloc / dealloc / clear
  ring.c                     # ring_create / destroy / write / read / peek / skip / clear
  scratch.c                  # scratch_begin / scratch_end implementations
  vmem.c                     # vmem_* implementations (Windows: VirtualAlloc; POSIX: mmap; fallback: malloc)
src/threads/
  thread.c                   # thread_create / thread_join / thread_detach / thread_get_id
  thread_current.c           # thread_current_* helpers
  thread_group.c             # thread_group_* implementations
  atomics.c                  # atomic_* implementations (SDL3 for 32-bit, stdatomic for 64-bit)
  condvar.c                  # condvar_* implementations
  mutex.c                    # mutex_* implementations
  rwlock.c                   # rwlock_* implementations
  semaphore.c                # semaphore_* implementations
  spinlock.c                 # spinlock_* implementations
tests/test_based.cpp         # GoogleTest tests (C++20, extern "C" wrapper)
CMakeLists.txt               # CMake build; fetches GoogleTest + SDL3 automatically
.clang-format                # Formatting config — always respect this
.clang-tidy                  # Linting config — always respect this
.cursor/rules/               # These rule files — keep them up to date when conventions change
```

## Build

- Library: C11 static (`based.lib` / `libbased.a`); links against SDL3 (used for thread/sync primitives)
- Tests: C++20, GoogleTest v1.14.0 (auto-fetched via FetchContent)
- Build dir: `build/`; run `cmake --build build` to compile

## Formatting & linting

All code must conform to `.clang-format` and pass `.clang-tidy` checks (warnings treated as errors). Never override or bypass these configs.

## License header

Every source file starts with:
```c
// MIT License
// Copyright (c) 2026 Christian Luppi
```

## Rule maintenance

**Every time a source or header file is created or deleted, the Structure section above must be updated in the same response — no exceptions.** Add the new file with a short description, or remove the deleted entry. Never finish a task that touches the file tree without syncing this rule.
